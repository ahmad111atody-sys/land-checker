#!/usr/bin/env python3
# ğŸ” Ø¨ÙˆØª Ù…Ø±Ø§Ù‚Ø¨Ø© Ù…Ø´Ø§Ø±ÙŠØ¹ Ø³ÙƒÙ†ÙŠ (Ø§Ù„Ø¨Ø³ØªØ§Ù† - Ù†Ø®Ù„Ø§Ù† - Ø¯Ø±Ø© Ø´Ø±ÙˆØ±Ø© - Ø³Ø­Ø¨Ø§Ù†)
# Ø¥Ø¹Ø¯Ø§Ø¯: Ø®Ø§Øµ Ø¨Ù…Ø´Ø±ÙˆØ¹ land-checker Ø¹Ù„Ù‰ Render

import os, time, json, requests, re
from datetime import datetime

# Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¨ÙˆØª Ù…Ù† Ø¨ÙŠØ¦Ø© Render
TELEGRAM_TOKEN = os.getenv("TELEGRAM_TOKEN", "").strip()
CHAT_ID = os.getenv("CHAT_ID", "").strip()
CHECK_INTERVAL_MIN = int(os.getenv("CHECK_INTERVAL_MIN", "10"))  # ÙƒÙ„ 10 Ø¯Ù‚Ø§Ø¦Ù‚

# Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹
PROJECT_FILES = {
    "ÙˆØ§Ø­Ø© Ø§Ù„Ø¨Ø³ØªØ§Ù† â€“ ØµØ¨ÙŠØ§": "alanwar.txt",
    "Ù†Ø®Ù„Ø§Ù†": "active_units.txt",
    "Ø¯Ø±Ø© Ø´Ø±ÙˆØ±Ø©": "shrora.txt",
    "Ø³Ø­Ø¨Ø§Ù†": "sahban.txt"
}

STATE_FILE = "seen_units.json"

# Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…
def send_message(text: str):
    if not TELEGRAM_TOKEN or not CHAT_ID:
        print("âš ï¸ Ù„Ù… ÙŠØªÙ… Ø¶Ø¨Ø· TELEGRAM_TOKEN Ø£Ùˆ CHAT_ID ÙÙŠ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª")
        return
    url = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage"
    data = {"chat_id": CHAT_ID, "text": text, "parse_mode": "HTML"}
    try:
        r = requests.post(url, data=data, timeout=15)
        print("ğŸ“¨ ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:", r.status_code)
    except Exception as e:
        print("âŒ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:", e)

# ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
def load_seen():
    if os.path.exists(STATE_FILE):
        try:
            with open(STATE_FILE, "r", encoding="utf-8") as f:
                return json.load(f)
        except:
            pass
    return {}

# Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
def save_seen(data):
    with open(STATE_FILE, "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=2)

# Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø­Ø§Ù„Ø© Ù…Ù† Ø§Ù„ØµÙØ­Ø©
def extract_status(html):
    t = html.lower()
    if "Ù…Ù„Øº" in t or "cancel" in t:
        return "Ù…Ù„ØºØ§Ø©"
    if "Ù…ØªØ§Ø­" in t or "available" in t:
        return "Ù…ØªØ§Ø­Ø©"
    if "Ù…Ø­Ø¬ÙˆØ²" in t or "reserved" in t:
        return "Ù…Ø­Ø¬ÙˆØ²Ø©"
    return "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"

# ÙØ­Øµ Ù‚Ø·Ø¹Ø© ÙˆØ§Ø­Ø¯Ø©
def check_unit(url):
    try:
        r = requests.get(url, timeout=20)
        if r.status_code != 200:
            return "ØºÙŠØ± Ù…ØªØ§Ø­"
        return extract_status(r.text)
    except Exception as e:
        print("âŒ", url, e)
        return "Ø®Ø·Ø£"

# ÙØ­Øµ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹
def check_all():
    seen = load_seen()
    updates = {}

    for proj_name, fname in PROJECT_FILES.items():
        if not os.path.exists(fname):
            print(f"âš ï¸ Ø§Ù„Ù…Ù„Ù {fname} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯")
            continue

        updates[proj_name] = []

        with open(fname, "r", encoding="utf-8") as f:
            for line in f:
                url = line.strip()
                if not url:
                    continue

                st = check_unit(url)
                old = seen.get(url)

                if old != st:
                    seen[url] = st
                    if st in ("Ù…Ù„ØºØ§Ø©", "Ù…ØªØ§Ø­Ø©"):
                        updates[proj_name].append((url, st))

    save_seen(seen)

    # Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
    for proj_name, lst in updates.items():
        if not lst:
            continue

        msg = f"ğŸ”” <b>ØªÙ… Ø§ÙƒØªØ´Ø§Ù Ù‚Ø·Ø¹Ø© Ø¬Ø¯ÙŠØ¯Ø© ÙÙŠ Ù…Ø´Ø±ÙˆØ¹ {proj_name}</b>\nğŸ•’ {datetime.now():%Y-%m-%d %H:%M}\n\n"
        for i, (u, s) in enumerate(lst, 1):
            pid = re.search(r"/units/(\d+)", u)
            num = pid.group(1) if pid else "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"
            msg += f"{i}) Ù‚Ø·Ø¹Ø© Ø±Ù‚Ù… <b>{num}</b> â€“ Ø§Ù„Ø­Ø§Ù„Ø©: {s}\nğŸ”— {u}\n\n"
        send_message(msg)

# Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
def main():
    print("âœ… ØªÙ… ØªØ´ØºÙŠÙ„ Ø¨ÙˆØª Ù…Ø±Ø§Ù‚Ø¨Ø© Ù…Ø´Ø§Ø±ÙŠØ¹ Ø³ÙƒÙ†ÙŠ")
    print("Ø³ÙŠØªÙ… Ø§Ù„ÙØ­Øµ ÙƒÙ„", CHECK_INTERVAL_MIN, "Ø¯Ù‚ÙŠÙ‚Ø©")
    while True:
        check_all()
        time.sleep(CHECK_INTERVAL_MIN * 60)

if __name__ == "__main__":
    main()